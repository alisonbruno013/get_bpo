name: Execução Agendada BPO

on:
  schedule:
    # Executa todos os dias às 09:00, 15:00, 18:00 e 00:00 UTC
    # Ajuste os horários conforme seu fuso horário
    # UTC-3 (Brasil): 09h BR = 12h UTC, 15h BR = 18h UTC, 18h BR = 21h UTC, 00h BR = 03h UTC
    - cron: '0 12,18,21,3 * * *'  # 09h, 15h, 18h, 00h (horário de Brasília)
  workflow_dispatch:  # Permite execução manual

jobs:
  run-bpo-script:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Instalar dependências
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Configurar credenciais
      env:
        EMAIL: ${{ secrets.BPO_EMAIL }}
        PASSWORD: ${{ secrets.BPO_PASSWORD }}
      run: |
        python -c "
        from config import Config
        Config.save_credentials('$EMAIL', '$PASSWORD')
        "
    
    - name: Configurar Google Sheets credentials
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > credentials.json
    
    - name: Instalar Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        # ChromeDriver é gerenciado automaticamente pelo webdriver-manager
    
    - name: Executar script BPO
      run: |
        python scriptMain.py
    
    - name: Upload de logs (se houver erro)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs
        paths: |
          downloads/
          *.log
